#!/bin/bash
d=~/nobackup/opensuse
c=$d/current/tumbleweed/repo/oss/
incoming=$d/incoming/tumbleweed/repo/oss/
PATH=/usr/local/bin:$PATH
mkdir -p $c $incoming
curl -s http://ftp.gwdg.de/pub/opensuse/tumbleweed/repo/oss/media.1/products | diff - $c/media.1/products && exit 0
rsync -ay --delete-delay --delay-updates rsync://ftp.gwdg.de/pub/opensuse/tumbleweed/repo/oss/ $incoming > /dev/null
ver=$(cut -c12-19 $incoming/media.1/products)
test -n "$ver" || exit 50    # sanity check
[[ $ver =~ ^20 ]] || exit 51 # sanity check
target=$d/history/"$ver"
test -d "$target" && exit 0 # already synced
checkrepo $incoming || exit 52
rm -rf $c && cp -al $incoming $d/current/tumbleweed/repo/
mkdir -p "$target"
cp -al $d/current/tumbleweed "$target/"
ipfs add -Q --pin --raw-leaves -r $d/current/ | tee ~/.ipfs/bmw/opensuse/newhead-$ver
echo "then: opensuse-add $(cat ~/.ipfs/bmw/opensuse/newhead-$ver)"
